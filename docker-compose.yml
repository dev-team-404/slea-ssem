version: '3.8'

# Outside-In ì „ëµ (ì‚¬ì™¸ GitHub â†’ ì‚¬ë‚´ GitHub ë‹¨ë°©í–¥ ë™ê¸°í™”)
# ê°œë°œ í™˜ê²½ìš© Docker Compose
# ì‚¬ì™¸(ê³µê°œ): ê¸°ë³¸ê°’ í¬í•¨
# ì‚¬ë‚´(íì‡„): .env ë˜ëŠ” docker-compose.override.ymlë¡œ ì˜¤ë²„ë¼ì´ë“œ

services:
  # ============================================================
  # PostgreSQL 15 ë°ì´í„°ë² ì´ìŠ¤
  # ============================================================
  db:
    image: postgres:15-alpine
    container_name: slea-db

    environment:
      # ê¸°ë³¸ê°’ (ì‚¬ì™¸)
      POSTGRES_DB: sleassem_dev
      POSTGRES_USER: slea_user
      POSTGRES_PASSWORD: change_me_dev_password

      # íƒ€ì„ì¡´ ì„¤ì •
      TZ: Asia/Seoul
      PGTZ: Asia/Seoul

    ports:
      # ë¡œì»¬ ê°œë°œìš© í¬íŠ¸ ë…¸ì¶œ (ì‚¬ì™¸)
      # ì‚¬ë‚´: docker-compose.override.ymlì—ì„œ ì œê±°
      - "5432:5432"

    volumes:
      # ë°ì´í„° ì˜ì†ì„±
      - postgres_data:/var/lib/postgresql/data

      # ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ (ì„ íƒ)
      # - ./infra/init-db.sql:/docker-entrypoint-initdb.d/init.sql

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U slea_user"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - slea-network

    restart: unless-stopped

  # ============================================================
  # FastAPI ë°±ì—”ë“œ
  # ============================================================
  backend:
    # ë¹Œë“œ ì„¤ì •
    build:
      context: .
      dockerfile: Dockerfile

      # ë¹Œë“œ ì‹œì  args (Proxy ìë™ ì£¼ì…)
      # .env íŒŒì¼ ë˜ëŠ” í˜¸ìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ì—ì„œ ìë™ ê°ì§€
      # ì‚¬ì™¸(ê¸°ë³¸ê°’): ë¹„ì›Œë‘  â†’ Dockerfileì—ì„œ ë¬´ì‹œ
      # ì‚¬ë‚´: .env ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ì„¤ì • â†’ ìë™ ì£¼ì…
      args:
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_EXTRA_INDEX_URL: ${PIP_EXTRA_INDEX_URL:-}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-db,localhost,127.0.0.1}

    container_name: slea-backend

    environment:
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      DATABASE_URL: postgresql://${DB_USER:-slea_user}:${DB_PASSWORD:-change_me_dev_password}@db:5432/${DB_NAME:-sleassem_dev}

      # FastAPI ì„¤ì •
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Python ì„¤ì •
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONPATH: /app

      # íƒ€ì„ì¡´
      TZ: Asia/Seoul

      # ì„ íƒ: í”„ë¡ì‹œ (ì‚¬ë‚´ í™˜ê²½ìš©)
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}

    ports:
      # ê°œë°œìš© í¬íŠ¸ ë…¸ì¶œ (ì‚¬ì™¸)
      # ì‚¬ë‚´: docker-compose.override.ymlì—ì„œ ì œê±°
      - "8000:8000"

    depends_on:
      db:
        condition: service_healthy

    volumes:
      # ì‹¤ì‹œê°„ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (ê°œë°œ ì¤‘)
      - .:/app

      # ìºì‹œ ì œì™¸
      - /app/.pytest_cache
      - /app/.mypy_cache
      - /app/__pycache__

    networks:
      - slea-network

    restart: unless-stopped

    # ê°œë°œ ëª¨ë“œ: ìë™ ë‹¤ì‹œë¡œë“œ í™œì„±í™”
    command: >
      sh -c "
        echo 'ğŸ”„ Waiting for database...';
        sleep 5;
        echo 'ğŸ“¦ Running migrations...';
        alembic upgrade head;
        echo 'ğŸš€ Starting Uvicorn server...';
        python -m uvicorn src.backend.main:app
          --host 0.0.0.0
          --port 8000
          --reload
      "

  # ============================================================
  # Redis ìºì‹œ (ì„ íƒ)
  # ============================================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: slea-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - slea-network
  #   restart: unless-stopped

# ============================================================
# ë„¤íŠ¸ì›Œí¬
# ============================================================
networks:
  slea-network:
    driver: bridge

# ============================================================
# ë³¼ë¥¨
# ============================================================
volumes:
  postgres_data:
    driver: local
  # redis_data:
  #   driver: local
