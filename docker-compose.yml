# Outside-In ì „ëµ (ì‚¬ì™¸ GitHub â†’ ì‚¬ë‚´ GitHub ë‹¨ë°©í–¥ ë™ê¸°í™”)
# ê°œë°œ í™˜ê²½ìš© Docker Compose
# ì‚¬ì™¸(ê³µê°œ): ê¸°ë³¸ê°’ í¬í•¨
# ì‚¬ë‚´(íì‡„): .env ë˜ëŠ” docker-compose.override.ymlë¡œ ì˜¤ë²„ë¼ì´ë“œ

services:
  # ============================================================
  # PostgreSQL 15 ë°ì´í„°ë² ì´ìŠ¤
  # ============================================================
  db:
    image: postgres:15-alpine
    container_name: slea-db

    environment:
      # ê¸°ë³¸ê°’ (ì‚¬ì™¸)
      POSTGRES_DB: sleassem_dev
      POSTGRES_USER: slea_user
      POSTGRES_PASSWORD: change_me_dev_password

      # ê°œë°œ í™˜ê²½: trust ì¸ì¦ìœ¼ë¡œ ì„¤ì • (ì›ê²© ì ‘ì† í—ˆìš©)
      POSTGRES_HOST_AUTH_METHOD: trust

      # íƒ€ì„ì¡´ ì„¤ì •
      TZ: Asia/Seoul
      PGTZ: Asia/Seoul

    ports:
      # ë¡œì»¬ ê°œë°œìš© í¬íŠ¸ ë…¸ì¶œ (ì‚¬ì™¸)
      # WSL ë¡œì»¬ PostgreSQLê³¼ì˜ ì¶©ëŒì„ í”¼í•˜ê¸° ìœ„í•´ 5433 ì‚¬ìš©
      # ì‚¬ë‚´: docker-compose.override.ymlì—ì„œ ì œê±°
      - "5433:5432"

    volumes:
      # ë°ì´í„° ì˜ì†ì„±
      - postgres_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U slea_user -d sleassem_dev"]
      interval: 300s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - slea-network

    restart: unless-stopped

  # ============================================================
  # FastAPI ë°±ì—”ë“œ
  # ============================================================
  backend:
    # ë¹Œë“œ ì„¤ì •
    build:
      context: .
      dockerfile: Dockerfile

      # ë¹Œë“œ ì‹œì  args (Proxy ìë™ ì£¼ì…)
      # .env íŒŒì¼ ë˜ëŠ” í˜¸ìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ì—ì„œ ìë™ ê°ì§€
      # ì‚¬ì™¸(ê¸°ë³¸ê°’): ë¹„ì›Œë‘  â†’ Dockerfileì—ì„œ ë¬´ì‹œ
      # ì‚¬ë‚´: .env ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ì„¤ì • â†’ ìë™ ì£¼ì…
      args:
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_EXTRA_INDEX_URL: ${PIP_EXTRA_INDEX_URL:-}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-db,localhost,127.0.0.1}

    container_name: slea-backend

    environment:
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      # ì£¼ì˜: 'db' í˜¸ìŠ¤íŠ¸ëª…ì€ Docker ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ ì´ë¦„
      # Docker ë‚´ë¶€ì—ì„œ PostgreSQL ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ 5432ì—ì„œ ë¦¬ìŠ¤ë‹
      # í˜¸ìŠ¤íŠ¸ì˜ í¬íŠ¸ 5433 ë§¤í•‘ì€ ì—¬ê¸°ì„œ ë¶ˆí•„ìš” (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í†µì‹ )
      DATABASE_URL: postgresql://${DB_USER:-slea_user}:${DB_PASSWORD:-change_me_dev_password}@db:5432/${DB_NAME:-sleassem_dev}

      # FastAPI ì„¤ì •
      HOST: 127.0.0.1
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Python ì„¤ì •
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONPATH: /app

      # íƒ€ì„ì¡´
      TZ: Asia/Seoul

      # LLM Configuration (Docker container â†’ Host LiteLLM)
      # host.docker.internal: í˜¸ìŠ¤íŠ¸ì˜ localhostì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ íŠ¹ìˆ˜ DNSëª…
      # ì°¸ê³ : Linuxì—ì„œëŠ” 172.17.0.1 ë˜ëŠ” host.docker.internal ì‚¬ìš©
      USE_LITE_LLM: "True"
      LITELLM_BASE_URL: ${LITELLM_BASE_URL:-http://host.docker.internal:4444/v1}
      LITELLM_API_KEY: ${LITELLM_API_KEY:-sk-4444}
      LITELLM_MODEL: ${LITELLM_MODEL:-gemini-2.0-flash}

      # ì„ íƒ: í”„ë¡ì‹œ (ì‚¬ë‚´ í™˜ê²½ìš©)
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}

    ports:
      # ê°œë°œìš© í¬íŠ¸ ë…¸ì¶œ (ì‚¬ì™¸)
      # ì‚¬ë‚´: docker-compose.override.ymlì—ì„œ ì œê±°
      - "8000:8000"

    depends_on:
      db:
        condition: service_healthy

    volumes:
      # ì‹¤ì‹œê°„ ì½”ë“œ ë³€ê²½ ë°˜ì˜ (ê°œë°œ ì¤‘)
      - .:/app

      # ìºì‹œ ì œì™¸
      - /app/.pytest_cache
      - /app/.mypy_cache
      - /app/__pycache__

    networks:
      - slea-network

    restart: unless-stopped

    # ê°œë°œ ëª¨ë“œ: uvicorn ì„œë²„ ì‹œì‘ (í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ ìœ„í•´ exec form ì‚¬ìš©)
    command:
      - /bin/sh
      - -c
      - |
        echo 'ğŸ”„ Waiting for database...';
        sleep 5;
        echo 'ğŸš€ Starting Uvicorn server...';
        python -m uvicorn src.backend.main:app --host 0.0.0.0 --port 8000

  # ============================================================
  # React í”„ë¡ íŠ¸ì—”ë“œ (Vite ê°œë°œ ì„œë²„)
  # ============================================================
  frontend:
    image: node:20-alpine
    container_name: slea-frontend

    working_dir: /app/src/frontend

    volumes:
      # ì†ŒìŠ¤ ì½”ë“œ ì‹¤ì‹œê°„ ë™ê¸°í™”
      - .:/app
      # node_modules ìºì‹œ (ë¡œì»¬ê³¼ ë¶„ë¦¬)
      - /app/src/frontend/node_modules

    ports:
      - "5173:5173"  # Vite dev server

    environment:
      # Vite ì„¤ì •
      VITE_API_URL: http://localhost:8000
      NODE_ENV: development
      PYTHONUNBUFFERED: 1

    command: >
      sh -c "
        echo 'ğŸ“¦ Installing dependencies...';
        npm install;
        echo 'ğŸš€ Starting Vite dev server...';
        npm run dev -- --host 0.0.0.0
      "

    networks:
      - slea-network

    restart: unless-stopped

    # Vite dev server ìƒíƒœ í™•ì¸
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================
  # Redis ìºì‹œ (ì„ íƒ)
  # ============================================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: slea-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - slea-network
  #   restart: unless-stopped

# ============================================================
# ë„¤íŠ¸ì›Œí¬
# ============================================================
networks:
  slea-network:
    driver: bridge

# ============================================================
# ë³¼ë¥¨
# ============================================================
volumes:
  postgres_data:
    driver: local
  # redis_data:
  #   driver: local
